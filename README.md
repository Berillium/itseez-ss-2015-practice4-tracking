# Практика 4. Детектирование особых точек и трекинг

## Цели

__Цель данной работы__ - получить общее представление о фундаментальных объектах
компьютерного зрения - особых точках. Рассмотреть одно из возможных применений -
трекинг объектов.

## Общая структура проекта

Данный репозиторий содержит:

  - `include` -- директория с заголовочным файлом, содержащим интерфейс трекера.
  - `samples` -- директория с исходным кодом приложения, которое запускает
    трекинг на видео. Имя алгоритма и путь к видео передаются параметрами
    командной строки. Кроме того, может быть указан файл с описанием
    ground-truth траектории, в этом случае приложение также выдаст метрики
    precision и recall для запускаемого трекера.
  - `dataset` -- директория с примерами видео. Для каждого видео имеется
    одноименный файл с расширением `.txt`, в котором указана ground-truth
    траектория.
  - `.gitignore` -- список файлов, находящихся в директории проекта,
     но игнорируемые git'ом.
  - `.travis.yml` -- конфигурационный файл для системы автоматического
     тестирования Travis-CI.
  - `CMakeLists.txt` -- общий файл для сборки проекта с помощью CMake.
  - `README.md` -- настоящий файл.

## Задачи

__Основные задачи__:

  1. Реализовать алгоритм трекинга Median Flow.
  2. Собрать качественные метрики на имеющемся наборе видео, дать им оценку.

__Дополнительные задачи__:

  1. Улучшить качественные оценки трекинга при помощи реализации вспомогательных
     процедур:
     - Использование различных способов фильтрации точек (фиксированный порог,
       среднее и т.п.).
     - Оценка масштаба.
     - Использование различных особых точек (Harris corners,
       `goodFeaturesToTrack`, SIFT/SURF/ORB features и т.п.).
     - Детектировать срыв трекинга.

## Общая последовательность действий

  1. Сделать форк upstream-репозитория, затем клонировать origin к себе на
     локальную машину. Для получения инструкций можно обратиться к разделу
     [Общие инструкции по работе с Git][git-intro]
     в [практической работе 1][practice1].
  2. Собрать проект с помощью CMake и MS VS (раздел
     [Сборка проекта с помощью CMake и MS VS][cmake-msvs]
     в [практической работе 1][practice1]). В результате успешной сборки в
     build-каталоге в директории `bin` должен появить исполняемый файл
     `tracking_sample.exe`.
  3. Запустить `tracking_sample.exe` для получения справки и разобраться с
     параметрами его запуска.
  4. Добавить новую реализацию интерфейса `Tracker`.
  5. Реализовать примитивную версию алгоритма Median Flow.
  6. Запустить реализованный трекер на различных видео из каталога `dataset`,
     проанализировать его качество.
  7. Реализовать полную версию алгоритма, проанализировать качество.
  8. Попытаться ещё улучшить качество (см. [Дополнительные задачи][tasks]).

## Детальная инструкция по выполнению работы

  1. Сделать форк upstream-репозитория, затем клонировать origin к себе на
     локальную машину. Для инструкций можно обратиться к разделу
     [Общие инструкции по работе с Git][git-intro]
     в [практической работе 1][practice1].
  2. Собрать проект с помощью CMake и MS VS (см. раздел
     [Сборка проекта с помощью CMake и MS VS][cmake-msvs]
     в [практической работе 1][practice1]). В результате успешной сборки
     в build-каталоге в директории `bin` долен появить исполняемый
     файл `tracking_sample.exe`
  3. Запустить `tracking_sample.exe` для получения справки и разобраться с
     параметрами его запуска.
     1. Приложение можно запускать без параметров - тогда оно просто выдает справку.
     2. Можно также передать 2 параметра так, как показано ниже. В
        результате откроется окно, в котором нужно будет мышью выбрать
        объект для трекинга. После чего будет показан результат трекинга
        с использованием указанного алгоритма (в данном случае - `dummy`).

     ```bash
     $ tracking_sample.exe dummy ../../dataset/car.mp4
     ```

     3. Можно передать 3 параметра так, как показано ниже. Тогда, кроме
        результатов указанного трекера, будет показана также разметка
        для сопровождаемого объекта (ground-truth). При этом по завершении
        видео, будут выведены качественные оценки алгоритма.

     ```bash
     $ tracking_sample.exe dummy ../../dataset/car.mp4 ../../dataset/car.txt
     ```

  4. Добавить новую реализацию интерфейса `Tracker`.
     1. Добавить новый файл с расширением `.cpp` в директорию `samples`
        (например, `tracker_median_flow.cpp`).
     2. Перезапустить CMake, чтобы он "подхватил" созданный файл.
     3. Реализовать в созданном файле интерфейс `Tracker`, аналогично реализации
        в файле `tracker_dummy.cpp`. Тела методов могут быть пока тривиальными.
     4. Добавить свою реализацию в функцию-фабрику `createTracker` в файле
        `trackers_factory.cpp`.
  5. Реализовать примитивную версию алгоритма Median Flow. Метод `track` в
     созданной реализации должен содержать:
     1. Выбор точек в прямоугольнике.
     2. Вычисление для них optical flow (и фильтрация "плохих" точек).
     3. Выбор медианных смещений по X и по Y.
  6. Запустить реализованный трекер на различных видео из каталога `dataset`,
     проанализировать его качество. Попробуйте ответить на вопросы:
     1. Насколько полученные оценки близки к 1? 
     2. В каких случаях алгоритм срабатывает плохо?
  7. Реализовать полную версию алгоритма, проанализировать качество. Шаги
     "полного" алгоритма следующие:
     1. Выбрать точки в прямоугольнике.
     2. Вычислить для них optical flow (и отбросить "плохие").
     3. *Вычислить обратный optical flow* (и отбросить плохие по forward-backward
        правилу).
     4. Взять медианные смещения по X и по Y.
     5. *Оценить масштаб*.
     Фильтрация по forward-backward правилу осуществляется следующим образом:
     1. Вычислить optical flow в обратном направлении.
     2. Отфильтровать точки - если положение оригинальной точки и её образа,
        вычисленного с помощью forward-backward flow "сильно" отличаются, её нужно
        отбросить.
     Фильтрация "плохих" точек осуществляется следующим образом:
     1. Найти медианную ошибку.
     2. Назначить "плохими" все точки с большей ошибкой.
     Оценка масштаба осуществляется следующим образом:
     1. Для всех пар точек нужно определить отношение расстояния между ними на
        предыдущем и следующем кадре.
     2. Выбрать медианное отношение.
  8. Попытаться ещё улучшить качество (см. [Дополнительные задачи][tasks]).


<!-- LINKS -->

[practice1]: https://github.com/Itseez-NNSU-SummerSchool2015/practice1-devtools
[git-intro]: https://github.com/Itseez-NNSU-SummerSchool2015/practice1-devtools#Общие-инструкции-по-работе-с-git
[cmake-msvs]: https://github.com/Itseez-NNSU-SummerSchool2015/practice1-devtools#Сборка-проекта-с-помощью-cmake-и-microsoft-visual-studio
[tasks]: https://github.com/Itseez-NNSU-SummerSchool2015/practice4-tracking#Задачи